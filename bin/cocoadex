#!/usr/bin/env ruby

require 'methadone'
require 'nokogiri'
require 'cocoadex'

include Methadone::Main
include Methadone::CLILogging
include Cocoadex

logger.error_level = Logger::ERROR

main do |arg|
  if options[:verbose]
    logger.error_level = Logger::DEBUG
  end

  if options[:'load-docset'] and path = File.expand_path(options[:'load-docset'].first)
    Parser.parse(path)
  end

  if options[:search] and text = options[:search].first
    if Keyword.loaded?
      logger.debug "Loading index..."
      Keyword.read
      Cocoadex.search(text, options[:first])
    else
      puts "No DocSets loaded"
    end
  end
end

version Cocoadex::VERSION
description 'A Class Reference Utility for Cocoa APIs'

on("--verbose","Be verbose")
on("--first","Load first result when multiple matches exist")

on("-d DOCSET","--load-docset","Load a DocSet into the datastore",/^(.*)$/)
on("-s QUERY","--search","Search the index",/^(.*)$/)

# todo: support --platform, --platform-version, --language, --first, --force

go!